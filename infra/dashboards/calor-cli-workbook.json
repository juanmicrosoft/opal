{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "resources": [
    {
      "type": "microsoft.insights/workbooks",
      "apiVersion": "2022-04-01",
      "name": "257c3a9a-29a3-4804-837c-26d1de930ad9",
      "location": "eastus",
      "kind": "shared",
      "properties": {
        "displayName": "Calor CLI - Telemetry Dashboard",
        "serializedData": "{\"version\": \"Notebook/1.0\", \"items\": [{\"type\": 1, \"content\": {\"json\": \"# ðŸ”¥ Calor CLI â€” Telemetry Dashboard\\nReal-time usage, performance, and error tracking for the Calor compiler CLI.\\n\\n---\"}, \"name\": \"header\"}, {\"type\": 3, \"content\": {\"version\": \"KqlItem/1.0\", \"query\": \"let cmds = customEvents\\n| where name in ('CommandSucceeded', 'CommandFailed');\\nlet total_cmds = toscalar(cmds | count);\\nlet succeeded = toscalar(cmds | where name == 'CommandSucceeded' | count);\\nlet sessions = toscalar(cmds | summarize dcount(tostring(customDimensions.operationId)));\\nlet avg_compile = toscalar(customEvents\\n    | where name == 'CommandSucceeded'\\n    | extend cmd = tostring(customDimensions.command)\\n    | where cmd == 'compile'\\n    | extend dur = todouble(customMeasurements.durationMs)\\n    | summarize round(avg(dur), 0));\\nlet errors = toscalar(traces | where severityLevel == 3 | count);\\nlet exceptions = toscalar(exceptions | count);\\nprint\\n    ['Total Commands'] = total_cmds,\\n    ['Success Rate %'] = iff(total_cmds > 0, round(100.0 * succeeded / total_cmds, 1), 0.0),\\n    ['Unique Sessions'] = sessions,\\n    ['Avg Compile (ms)'] = avg_compile,\\n    ['Compiler Errors'] = errors,\\n    ['Exceptions'] = exceptions\", \"size\": 3, \"title\": \"Key Metrics â€” Last 30 Days\", \"queryType\": 0, \"resourceType\": \"microsoft.insights/components\", \"visualization\": \"table\", \"gridSettings\": {\"formatters\": [{\"columnMatch\": \"Total Commands\", \"formatter\": 1, \"formatOptions\": {\"customColumnWidthSetting\": \"150px\"}}, {\"columnMatch\": \"Success Rate %\", \"formatter\": 1, \"formatOptions\": {\"customColumnWidthSetting\": \"150px\"}}, {\"columnMatch\": \"Unique Sessions\", \"formatter\": 1, \"formatOptions\": {\"customColumnWidthSetting\": \"150px\"}}, {\"columnMatch\": \"Avg Compile\", \"formatter\": 1, \"formatOptions\": {\"customColumnWidthSetting\": \"150px\"}}, {\"columnMatch\": \"Compiler Errors\", \"formatter\": 1, \"formatOptions\": {\"customColumnWidthSetting\": \"150px\"}}, {\"columnMatch\": \"Exceptions\", \"formatter\": 1, \"formatOptions\": {\"customColumnWidthSetting\": \"150px\"}}]}}, \"name\": \"kpi-summary\"}, {\"type\": 1, \"content\": {\"json\": \"## ðŸ“Š Command Usage\"}, \"name\": \"usage-header\"}, {\"type\": 3, \"content\": {\"version\": \"KqlItem/1.0\", \"query\": \"customEvents\\n| where name in ('CommandSucceeded', 'CommandFailed')\\n| extend command = tostring(customDimensions.command)\\n| summarize count() by command, bin(timestamp, 1d)\\n| render timechart\", \"size\": 0, \"title\": \"Command Usage Over Time\", \"queryType\": 0, \"resourceType\": \"microsoft.insights/components\", \"visualization\": \"unstackedbar\"}, \"name\": \"usage-timeline\"}, {\"type\": 3, \"content\": {\"version\": \"KqlItem/1.0\", \"query\": \"customEvents\\n| where name in ('CommandSucceeded', 'CommandFailed')\\n| extend command = tostring(customDimensions.command)\\n| summarize count() by command\\n| order by count_ desc\\n| render piechart\", \"size\": 1, \"title\": \"Command Distribution\", \"queryType\": 0, \"resourceType\": \"microsoft.insights/components\", \"visualization\": \"piechart\"}, \"name\": \"usage-distribution\"}, {\"type\": 3, \"content\": {\"version\": \"KqlItem/1.0\", \"query\": \"customEvents\\n| where name in ('CommandSucceeded', 'CommandFailed')\\n| summarize count() by Outcome = name\\n| render piechart\", \"size\": 1, \"title\": \"Success vs Failure\", \"queryType\": 0, \"resourceType\": \"microsoft.insights/components\", \"visualization\": \"piechart\"}, \"name\": \"usage-outcome\"}, {\"type\": 1, \"content\": {\"json\": \"## âš¡ Performance\"}, \"name\": \"perf-header\"}, {\"type\": 3, \"content\": {\"version\": \"KqlItem/1.0\", \"query\": \"dependencies\\n| where type == 'CompilationPhase'\\n| summarize avg_ms = round(avg(duration), 1) by Phase = name\\n| order by avg_ms desc\\n| render barchart with (title='Average Phase Duration (ms)')\", \"size\": 0, \"title\": \"Compilation Phase Performance\", \"queryType\": 0, \"resourceType\": \"microsoft.insights/components\", \"visualization\": \"barchart\"}, \"name\": \"perf-phases-chart\"}, {\"type\": 3, \"content\": {\"version\": \"KqlItem/1.0\", \"query\": \"dependencies\\n| where type == 'CompilationPhase'\\n| summarize\\n    ['Avg (ms)'] = round(avg(duration), 1),\\n    ['P50 (ms)'] = round(percentile(duration, 50), 1),\\n    ['P95 (ms)'] = round(percentile(duration, 95), 1),\\n    Failures = countif(success == false),\\n    Total = count()\\n    by Phase = name\\n| extend ['Failure %'] = round(100.0 * Failures / Total, 1)\\n| project Phase, ['Avg (ms)'], ['P50 (ms)'], ['P95 (ms)'], ['Failure %'], Total\\n| order by ['Avg (ms)'] desc\", \"size\": 1, \"title\": \"Phase Performance Detail\", \"queryType\": 0, \"resourceType\": \"microsoft.insights/components\", \"visualization\": \"table\"}, \"name\": \"perf-phases-table\"}, {\"type\": 3, \"content\": {\"version\": \"KqlItem/1.0\", \"query\": \"customEvents\\n| where name == 'CommandSucceeded'\\n| extend command = tostring(customDimensions.command), dur = todouble(customMeasurements.durationMs)\\n| summarize\\n    ['Avg (ms)'] = round(avg(dur), 0),\\n    ['P50 (ms)'] = round(percentile(dur, 50), 0),\\n    ['P95 (ms)'] = round(percentile(dur, 95), 0),\\n    Invocations = count()\\n    by Command = command\\n| order by ['Avg (ms)'] desc\", \"size\": 1, \"title\": \"Average Command Duration\", \"queryType\": 0, \"resourceType\": \"microsoft.insights/components\", \"visualization\": \"table\"}, \"name\": \"perf-cmd-duration\"}, {\"type\": 1, \"content\": {\"json\": \"## ðŸ› Diagnostics & Errors\"}, \"name\": \"diag-header\"}, {\"type\": 3, \"content\": {\"version\": \"KqlItem/1.0\", \"query\": \"traces\\n| where severityLevel >= 2\\n| extend Code = tostring(customDimensions.diagnosticCode),\\n    Severity = case(severityLevel == 3, 'ðŸ”´ Error', severityLevel == 2, 'ðŸŸ¡ Warning', 'Info')\\n| summarize Count = count() by Code, Severity\\n| order by Count desc\\n| take 20\", \"size\": 1, \"title\": \"Top 20 Compiler Diagnostics\", \"queryType\": 0, \"resourceType\": \"microsoft.insights/components\", \"visualization\": \"table\"}, \"name\": \"diag-top-codes\"}, {\"type\": 3, \"content\": {\"version\": \"KqlItem/1.0\", \"query\": \"exceptions\\n| summarize count() by bin(timestamp, 1d), type\\n| render timechart\", \"size\": 0, \"title\": \"Exception Trends\", \"queryType\": 0, \"resourceType\": \"microsoft.insights/components\", \"visualization\": \"timechart\"}, \"name\": \"diag-exception-trends\"}, {\"type\": 3, \"content\": {\"version\": \"KqlItem/1.0\", \"query\": \"exceptions\\n| project timestamp, type, outerMessage, innermostMessage,\\n    command = tostring(customDimensions.command),\\n    session = tostring(customDimensions.operationId)\\n| order by timestamp desc\\n| take 15\", \"size\": 1, \"title\": \"Recent Exceptions\", \"queryType\": 0, \"resourceType\": \"microsoft.insights/components\", \"visualization\": \"table\"}, \"name\": \"diag-exception-detail\"}, {\"type\": 1, \"content\": {\"json\": \"## ðŸ–¥ï¸ Environment\"}, \"name\": \"env-header\"}, {\"type\": 3, \"content\": {\"version\": \"KqlItem/1.0\", \"query\": \"customEvents\\n| where name in ('CommandSucceeded', 'CommandFailed')\\n| extend os = tostring(customDimensions.os)\\n| summarize count() by os\\n| render piechart\", \"size\": 1, \"title\": \"OS Distribution\", \"queryType\": 0, \"resourceType\": \"microsoft.insights/components\", \"visualization\": \"piechart\"}, \"name\": \"env-os\"}, {\"type\": 3, \"content\": {\"version\": \"KqlItem/1.0\", \"query\": \"customEvents\\n| where name in ('CommandSucceeded', 'CommandFailed')\\n| extend arch = tostring(customDimensions.arch)\\n| summarize count() by arch\\n| render piechart\", \"size\": 1, \"title\": \"Architecture Distribution\", \"queryType\": 0, \"resourceType\": \"microsoft.insights/components\", \"visualization\": \"piechart\"}, \"name\": \"env-arch\"}, {\"type\": 3, \"content\": {\"version\": \"KqlItem/1.0\", \"query\": \"customEvents\\n| where name in ('CommandSucceeded', 'CommandFailed')\\n| extend version = tostring(customDimensions.calorVersion)\\n| summarize count() by version\\n| render piechart\", \"size\": 1, \"title\": \"Calor Version Adoption\", \"queryType\": 0, \"resourceType\": \"microsoft.insights/components\", \"visualization\": \"piechart\"}, \"name\": \"env-version\"}, {\"type\": 3, \"content\": {\"version\": \"KqlItem/1.0\", \"query\": \"customEvents\\n| where name in ('CommandSucceeded', 'CommandFailed')\\n| extend agents = tostring(customDimensions.codingAgent)\\n| mv-expand agent = split(agents, ',')\\n| extend agent = tostring(agent)\\n| where agent != ''\\n| summarize count() by agent\\n| render piechart\", \"size\": 1, \"title\": \"Coding Agent Distribution\", \"queryType\": 0, \"resourceType\": \"microsoft.insights/components\", \"visualization\": \"piechart\"}, \"name\": \"env-agent\"}, {\"type\": 1, \"content\": {\"json\": \"## ðŸŽ›ï¸ Feature Adoption\"}, \"name\": \"features-header\"}, {\"type\": 3, \"content\": {\"version\": \"KqlItem/1.0\", \"query\": \"customEvents\\n| where name == 'CompileOptions'\\n| extend\\n    strictApi = tostring(customDimensions.strictApi),\\n    requireDocs = tostring(customDimensions.requireDocs),\\n    enforceEffects = tostring(customDimensions.enforceEffects),\\n    strictEffects = tostring(customDimensions.strictEffects),\\n    verify = tostring(customDimensions.verify)\\n| summarize\\n    strictApi_on = countif(strictApi == 'True'),\\n    docs_on = countif(requireDocs == 'True'),\\n    effects_on = countif(enforceEffects == 'True'),\\n    strictFx_on = countif(strictEffects == 'True'),\\n    verify_on = countif(verify == 'True'),\\n    total = count()\\n| project\\n    ['Strict API %'] = round(100.0 * strictApi_on / total, 1),\\n    ['Require Docs %'] = round(100.0 * docs_on / total, 1),\\n    ['Enforce Effects %'] = round(100.0 * effects_on / total, 1),\\n    ['Strict Effects %'] = round(100.0 * strictFx_on / total, 1),\\n    ['Verify %'] = round(100.0 * verify_on / total, 1),\\n    ['Total Compilations'] = total\", \"size\": 1, \"title\": \"Compiler Feature Adoption\", \"queryType\": 0, \"resourceType\": \"microsoft.insights/components\", \"visualization\": \"table\"}, \"name\": \"features-flags\"}, {\"type\": 1, \"content\": {\"json\": \"## ðŸ›¡ï¸ Hook Compliance\"}, \"name\": \"hook-header\"}, {\"type\": 3, \"content\": {\"version\": \"KqlItem/1.0\", \"query\": \"let hooks = customEvents\\n| where name in ('HookAllow', 'HookBlock');\\nlet total = toscalar(hooks | count);\\nlet calr_writes = toscalar(hooks | where name == 'HookAllow' and tostring(customDimensions.fileExtension) == '.calr' | count);\\nlet cs_blocks = toscalar(hooks | where name == 'HookBlock' and tostring(customDimensions.fileExtension) == '.cs' | count);\\nlet cs_allows = toscalar(hooks | where name == 'HookAllow' and tostring(customDimensions.fileExtension) == '.cs' | count);\\nprint\\n    ['Total Hook Calls'] = total,\\n    ['.calr Writes'] = calr_writes,\\n    ['.cs Blocks'] = cs_blocks,\\n    ['.cs Allowed (obj/generated)'] = cs_allows,\\n    ['Compliance %'] = iff(total > 0, round(100.0 * calr_writes / total, 1), 0.0)\", \"size\": 3, \"title\": \"Hook Compliance Summary\", \"queryType\": 0, \"resourceType\": \"microsoft.insights/components\", \"visualization\": \"table\"}, \"name\": \"hook-kpi\"}, {\"type\": 3, \"content\": {\"version\": \"KqlItem/1.0\", \"query\": \"customEvents\\n| where name in ('HookAllow', 'HookBlock')\\n| extend decision = tostring(customDimensions.decision),\\n    ext = tostring(customDimensions.fileExtension)\\n| extend label = strcat(decision, ' (', ext, ')')\\n| summarize count() by label, bin(timestamp, 1d)\\n| render timechart\", \"size\": 0, \"title\": \"Hook Decisions Over Time\", \"queryType\": 0, \"resourceType\": \"microsoft.insights/components\", \"visualization\": \"timechart\"}, \"name\": \"hook-timeline\"}, {\"type\": 3, \"content\": {\"version\": \"KqlItem/1.0\", \"query\": \"customEvents\\n| where name in ('HookAllow', 'HookBlock')\\n| extend agent = tostring(customDimensions.agent),\\n    decision = name\\n| summarize\\n    Allows = countif(decision == 'HookAllow'),\\n    Blocks = countif(decision == 'HookBlock'),\\n    Total = count()\\n    by Agent = agent\\n| extend ['Compliance %'] = round(100.0 * Allows / Total, 1)\\n| order by Total desc\", \"size\": 1, \"title\": \"Per-Agent Hook Compliance\", \"queryType\": 0, \"resourceType\": \"microsoft.insights/components\", \"visualization\": \"table\"}, \"name\": \"hook-agent-table\"}, {\"type\": 3, \"content\": {\"version\": \"KqlItem/1.0\", \"query\": \"customEvents\\n| where name == 'HookBlock'\\n| extend\\n    hook = tostring(customDimensions.hook),\\n    ext = tostring(customDimensions.fileExtension),\\n    agent = tostring(customDimensions.agent)\\n| project timestamp, hook, ext, agent\\n| order by timestamp desc\\n| take 25\", \"size\": 0, \"title\": \"Recent Blocks (Last 25)\", \"queryType\": 0, \"resourceType\": \"microsoft.insights/components\", \"visualization\": \"table\"}, \"name\": \"hook-recent-blocks\"}, {\"type\": 1, \"content\": {\"json\": \"## ðŸš¨ Recent Failures\"}, \"name\": \"failures-header\"}, {\"type\": 3, \"content\": {\"version\": \"KqlItem/1.0\", \"query\": \"customEvents\\n| where name == 'CommandFailed'\\n| extend\\n    command = tostring(customDimensions.command),\\n    exitCode = tostring(customDimensions.exitCode),\\n    os = tostring(customDimensions.os),\\n    agent = tostring(customDimensions.codingAgent),\\n    version = tostring(customDimensions.calorVersion),\\n    sessionId = tostring(customDimensions.operationId),\\n    dur_ms = tostring(customMeasurements.durationMs)\\n| project timestamp, command, exitCode, dur_ms, os, agent, version, sessionId\\n| order by timestamp desc\\n| take 25\", \"size\": 0, \"title\": \"Last 25 Failed Commands\", \"queryType\": 0, \"resourceType\": \"microsoft.insights/components\", \"visualization\": \"table\"}, \"name\": \"failures-table\"}], \"fallbackResourceIds\": [\"/subscriptions/30f1eeac-d958-4ee6-8130-71ed2c8b9055/resourceGroups/Calor_AI_Language/providers/microsoft.insights/components/CalorCli\"], \"fromTemplateId\": \"sentinel-UserWorkbook\", \"$schema\": \"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}",
        "version": "Notebook/1.0",
        "sourceId": "/subscriptions/30f1eeac-d958-4ee6-8130-71ed2c8b9055/resourceGroups/Calor_AI_Language/providers/microsoft.insights/components/CalorCli",
        "category": "workbook"
      }
    }
  ]
}